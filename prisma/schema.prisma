generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  PLAYER
}

enum MemberRole {
  OWNER
  OFFICER
  PLAYER
  ALLIANCE
}

enum MemberStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

enum EventStatus {
  DRAFT
  PUBLISHED
  LOCKED
  COMPLETED
}

enum SignupStatus {
  ACTIVE
  WITHDRAWN
}

enum RegearStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id            String   @id @default(cuid())
  discordUserId String   @unique @map("discord_user_id")
  discordName   String   @map("discord_name")
  inGameName    String?  @map("in_game_name")
  avatarUrl     String?  @map("avatar_url")
  role          UserRole @default(PLAYER)
  createdAt     DateTime @default(now()) @map("created_at")

  eventsCreated    Event[]
  signups          Signup[]
  assignmentsGiven Assignment[]     @relation("AssignedBy")
  assignmentsRecvd Assignment[]     @relation("AssignedTo")
  auditLogs        AuditLog[]
  roleSpecs        PlayerRoleSpec[]
  memberships      GuildMembership[]
  ownedGuilds      Guild[]          @relation("GuildOwner")
  balanceActions   BalanceTransaction[] @relation("BalancePerformer")
  regearRequests   RegearRequest[]
  regearReviews    RegearRequest[]      @relation("RegearReviewer")

  @@map("users")
}

model Guild {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  logoUrl     String?  @map("logo_url")
  inviteCode          String   @unique @map("invite_code")
  ownerId             String   @map("owner_id")
  discordGuildId      String?  @unique @map("discord_guild_id")
  discordMemberRoleId String?  @map("discord_member_role_id")
  discordBotInstalled Boolean  @default(false) @map("discord_bot_installed")
  createdAt           DateTime @default(now()) @map("created_at")

  owner      User              @relation("GuildOwner", fields: [ownerId], references: [id])
  members    GuildMembership[]
  events     Event[]
  roles      GuildRole2[]
  categories GuildCategory[]
  templates  GuildTemplate[]

  @@map("guilds")
}

model GuildMembership {
  id           String       @id @default(cuid())
  userId       String       @map("user_id")
  guildId      String       @map("guild_id")
  role         MemberRole   @default(PLAYER)
  status       MemberStatus @default(PENDING)
  balance           Int          @default(0)
  lastSeenBalanceAt DateTime     @default(now()) @map("last_seen_balance_at")
  verifiedById      String?      @map("verified_by_id")
  verifiedAt   DateTime?    @map("verified_at")
  joinedAt     DateTime     @default(now()) @map("joined_at")

  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  guild        Guild               @relation(fields: [guildId], references: [id], onDelete: Cascade)
  transactions     BalanceTransaction[]
  regearRequests   RegearRequest[]

  @@unique([userId, guildId])
  @@map("guild_memberships")
}

model BalanceTransaction {
  id            String   @id @default(cuid())
  membershipId  String   @map("membership_id")
  amount        Int
  balanceAfter  Int      @map("balance_after")
  reason        String?
  performedById String   @map("performed_by_id")
  createdAt     DateTime @default(now()) @map("created_at")

  membership  GuildMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  performedBy User            @relation("BalancePerformer", fields: [performedById], references: [id])

  @@map("balance_transactions")
}

model Event {
  id           String      @id @default(cuid())
  guildId      String      @map("guild_id")
  title        String
  description  String?
  startTime    DateTime    @map("start_time")
  timezone     String      @default("UTC")
  locationNote String?     @map("location_note")
  status       EventStatus @default(DRAFT)
  createdById  String      @map("created_by")
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  guild       Guild        @relation(fields: [guildId], references: [id], onDelete: Cascade)
  createdBy   User         @relation(fields: [createdById], references: [id])
  parties     Party[]
  signups     Signup[]
  assignments Assignment[]
  auditLogs       AuditLog[]
  regearRequests  RegearRequest[]

  @@map("events")
}

model Party {
  id           String @id @default(cuid())
  eventId      String @map("event_id")
  name         String
  displayOrder Int    @default(0) @map("display_order")

  event     Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)
  roleSlots RoleSlot[]

  @@map("parties")
}

model RoleSlot {
  id           String   @id @default(cuid())
  partyId      String   @map("party_id")
  roleName     String   @map("role_name")
  capacity     Int      @default(1)
  tags         String[] @default([])
  minIp        Int?     @map("min_ip")
  notes        String?  @map("notes")
  displayOrder Int      @default(0) @map("display_order")

  party       Party        @relation(fields: [partyId], references: [id], onDelete: Cascade)
  assignments Assignment[]

  @@map("role_slots")
}

model Signup {
  id             String       @id @default(cuid())
  eventId        String       @map("event_id")
  userId         String       @map("user_id")
  preferredRoles String[]     @map("preferred_roles")
  note           String?
  status         SignupStatus @default(ACTIVE)
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  event      Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user       User        @relation(fields: [userId], references: [id])
  assignment Assignment?

  @@unique([eventId, userId])
  @@map("signups")
}

model Assignment {
  id           String   @id @default(cuid())
  eventId      String   @map("event_id")
  userId       String   @map("user_id")
  roleSlotId   String   @map("role_slot_id")
  signupId     String   @unique @map("signup_id")
  assignedById String   @map("assigned_by")
  assignedAt   DateTime @default(now()) @map("assigned_at")

  event      Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user       User     @relation("AssignedTo", fields: [userId], references: [id])
  roleSlot   RoleSlot @relation(fields: [roleSlotId], references: [id])
  signup     Signup   @relation(fields: [signupId], references: [id])
  assignedBy User     @relation("AssignedBy", fields: [assignedById], references: [id])

  @@unique([eventId, userId])
  @@map("assignments")
}

model AuditLog {
  id        String   @id @default(cuid())
  eventId   String   @map("event_id")
  userId    String   @map("user_id")
  action    String
  details   Json?
  createdAt DateTime @default(now()) @map("created_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

model GuildCategory {
  id           String   @id @default(cuid())
  guildId      String   @map("guild_id")
  name         String
  color        String   @default("#6b7280")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")

  guild Guild       @relation(fields: [guildId], references: [id], onDelete: Cascade)
  roles GuildRole2[]

  @@unique([guildId, name])
  @@map("guild_categories")
}

model GuildRole2 {
  id           String   @id @default(cuid())
  guildId      String   @map("guild_id")
  name         String
  categoryId   String?  @map("category_id")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")

  guild       Guild           @relation(fields: [guildId], references: [id], onDelete: Cascade)
  category    GuildCategory?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  specialists PlayerRoleSpec[]

  @@unique([guildId, name])
  @@map("guild_roles2")
}

model PlayerRoleSpec {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  roleId    String   @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")

  user User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  role GuildRole2 @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("player_role_specs")
}

model GuildTemplate {
  id        String   @id @default(cuid())
  guildId   String   @map("guild_id")
  name      String
  data      Json
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@unique([guildId, name])
  @@map("guild_templates")
}

model GuildRole {
  id           String   @id @default(cuid())
  name         String   @unique
  color        String   @default("#6b7280")
  category     String   @default("flex")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")

  @@map("guild_roles")
}

model RegearRequest {
  id             String       @id @default(cuid())
  eventId        String       @map("event_id")
  userId         String       @map("user_id")
  membershipId   String       @map("membership_id")
  screenshotData String       @map("screenshot_data") @db.Text
  note           String?
  status         RegearStatus @default(PENDING)
  silverAmount   Int?         @map("silver_amount")
  reviewNote     String?      @map("review_note")
  reviewedById   String?      @map("reviewed_by_id")
  reviewedAt     DateTime?    @map("reviewed_at")
  createdAt      DateTime     @default(now()) @map("created_at")

  event      Event           @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user       User            @relation(fields: [userId], references: [id])
  membership GuildMembership @relation(fields: [membershipId], references: [id])
  reviewedBy User?           @relation("RegearReviewer", fields: [reviewedById], references: [id])

  @@unique([eventId, userId])
  @@map("regear_requests")
}
